#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="$BASE_DIR/.bin"
BIN="$BIN_DIR/kagi-fastgpt"

if ! command -v go >/dev/null 2>&1; then
  echo "Error: Go 1.26+ is required but not installed or not in PATH." >&2
  echo "Install Go: https://go.dev/dl/" >&2
  exit 1
fi

GO_VERSION="$(go env GOVERSION 2>/dev/null || true)"
if [[ -n "$GO_VERSION" ]]; then
  GO_VERSION="${GO_VERSION#go}"
  GO_MAJOR="${GO_VERSION%%.*}"
  GO_REST="${GO_VERSION#*.}"
  GO_MINOR="${GO_REST%%.*}"
  if [[ "$GO_MAJOR" -lt 1 || ( "$GO_MAJOR" -eq 1 && "$GO_MINOR" -lt 26 ) ]]; then
    echo "Error: Go 1.26+ required, found go${GO_VERSION}" >&2
    exit 1
  fi
fi

needs_build=0
if [[ ! -x "$BIN" ]]; then
  needs_build=1
else
  for src in "$BASE_DIR"/*.go "$BASE_DIR"/go.mod; do
    if [[ -e "$src" && "$src" -nt "$BIN" ]]; then
      needs_build=1
      break
    fi
  done
fi

if [[ "$needs_build" -eq 1 ]]; then
  mkdir -p "$BIN_DIR"
  (
    cd "$BASE_DIR"
    go build -o "$BIN" .
  )
fi

exec "$BIN" "$@"
